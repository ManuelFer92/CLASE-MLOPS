name: model-training
on: [push]

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Necesario para poder hacer push al repo

    steps:
      # --- 1ï¸âƒ£ Clona el repositorio ---
      - uses: actions/checkout@v3

      # --- 2ï¸âƒ£ Configura Python ---
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # --- 3ï¸âƒ£ Instala CML (opcional para comentarios) ---
      - uses: iterative/setup-cml@v1

      # --- 4ï¸âƒ£ Entrena modelo y genera mÃ©tricas + grÃ¡ficos ---
      - name: Train model and update README
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Instalando dependencias..."
          pip install -r requirements.txt

          echo "ğŸ“˜ Ejecutando entrenamiento..."
          python train.py

          echo "ğŸ“Š Generando grÃ¡ficos..."
          python - <<'EOF'
          import pandas as pd
          import matplotlib.pyplot as plt
          import seaborn as sns
          import re

          # Leer el metrics.txt generado
          with open("metrics.txt", "r", encoding="utf-8") as f:
              text = f.read()

          lines = re.findall(r"([A-Za-zÃÃ‰ÃÃ“ÃšÃœÃ‘Ã±\s]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+(\d+)", text)
          if not lines:
              print("âš ï¸ No se encontraron mÃ©tricas por clase.")
          else:
              df = pd.DataFrame(lines, columns=["Label", "Precision", "Recall", "F1", "Support"])
              df[["Precision","Recall","F1"]] = df[["Precision","Recall","F1"]].astype(float)
              df = df[~df["Label"].str.contains("avg|accuracy|Confusion", case=False)]
              sns.set(style="whitegrid", font_scale=1)
              palette = ["#0078D4", "#742774", "#FFB900"]

              # F1-score
              plt.figure(figsize=(7,4))
              sns.barplot(x="Label", y="F1", data=df, palette=palette)
              plt.title("ComparaciÃ³n de F1-score por categorÃ­a", fontsize=13, fontweight="bold")
              plt.ylim(0, 1)
              for i,v in enumerate(df["F1"]):
                  plt.text(i, v+0.02, f"{v:.2f}", ha="center", fontsize=9)
              plt.tight_layout()
              plt.savefig("plot_f1.png", dpi=200)

              # Precision y Recall
              plt.figure(figsize=(7,4))
              df_m = df.melt(id_vars="Label", value_vars=["Precision","Recall"], var_name="MÃ©trica", value_name="Valor")
              sns.barplot(x="Label", y="Valor", hue="MÃ©trica", data=df_m, palette=["#0078D4","#742774"])
              plt.title("ComparaciÃ³n de Precision y Recall por categorÃ­a", fontsize=13, fontweight="bold")
              plt.ylim(0, 1)
              plt.legend(title="")
              plt.tight_layout()
              plt.savefig("plot_pr.png", dpi=200)
              print("âœ… GrÃ¡ficos generados: plot_f1.png y plot_pr.png")
          EOF

          echo "ğŸ“ Actualizando README.md con los resultados..."
          echo "## ğŸ“ˆ Resultados de Entrenamiento" > report.md
          cat metrics.txt >> report.md
          echo "" >> report.md
          echo "### ğŸ”¹ DesempeÃ±o visual" >> report.md
          echo "![](./plot_f1.png)" >> report.md
          echo "" >> report.md
          echo "![](./plot_pr.png)" >> report.md

          # Si existe README, lo combina al final
          if [ -f README.md ]; then
            echo "\n\n---\n\n" >> README.md
            cat report.md >> README.md
          else
            cp report.md README.md
          fi

          echo "ğŸ“¤ Commit y push de resultados..."
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add README.md plot_f1.png plot_pr.png metrics.txt
          git commit -m "ğŸ“ˆ ActualizaciÃ³n automÃ¡tica de mÃ©tricas y grÃ¡ficos"
          git push

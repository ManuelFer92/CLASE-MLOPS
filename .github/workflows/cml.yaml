name: model-training
on: [push]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      # --- 1ï¸âƒ£ Clona el repositorio ---
      - uses: actions/checkout@v3

      # --- 2ï¸âƒ£ Configura Python ---
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # --- 3ï¸âƒ£ Instala CML para publicar reportes ---
      - uses: iterative/setup-cml@v1

      # --- 4ï¸âƒ£ Entrenamiento y generaciÃ³n de mÃ©tricas ---
      - name: Train model and generate metrics
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Instalando dependencias..."
          pip install -r requirements.txt

          echo "ğŸ“˜ Ejecutando entrenamiento..."
          python train.py

          echo "ğŸ“Š Generando grÃ¡ficos de resultados..."
          python - <<'EOF'
          import pandas as pd
          import matplotlib.pyplot as plt
          import seaborn as sns
          import re

          # Leer el metrics.txt generado por train.py
          with open("metrics.txt", "r", encoding="utf-8") as f:
              text = f.read()

          # Extraer mÃ©tricas por clase (labels con mayÃºsculas/minÃºsculas y tildes)
          lines = re.findall(r"([A-Za-zÃÃ‰ÃÃ“ÃšÃœÃ‘Ã±\s]+)\s+([\d.]+)\s+([\d.]+)\s+([\d.]+)\s+(\d+)", text)
          if not lines:
              print("âš ï¸ No se encontraron mÃ©tricas por clase, revisa metrics.txt")
          else:
              df = pd.DataFrame(lines, columns=["Label", "Precision", "Recall", "F1", "Support"])
              df[["Precision", "Recall", "F1"]] = df[["Precision", "Recall", "F1"]].astype(float)
              df["Label"] = df["Label"].str.strip()

              # Filtrar solo las clases vÃ¡lidas (sin macro/weighted avg)
              df = df[~df["Label"].str.contains("avg|accuracy|Confusion", case=False)]

              # --- ğŸ¨ Estilo corporativo Core365 ---
              sns.set(style="whitegrid", font_scale=1.0)
              palette = ["#0078D4", "#742774", "#FFB900"]

              # --- GrÃ¡fico F1-score ---
              plt.figure(figsize=(7,4))
              sns.barplot(x="Label", y="F1", data=df, palette=palette)
              plt.title("ComparaciÃ³n de F1-score por categorÃ­a", fontsize=13, fontweight="bold")
              plt.ylabel("F1-score")
              plt.xlabel("CategorÃ­as")
              plt.ylim(0, 1)
              for i, v in enumerate(df["F1"]):
                  plt.text(i, v + 0.02, f"{v:.2f}", ha="center", fontsize=9)
              plt.tight_layout()
              plt.savefig("plot_f1.png", dpi=200)
              print("âœ… GrÃ¡fico F1-score generado: plot_f1.png")

              # --- GrÃ¡fico Precision y Recall ---
              plt.figure(figsize=(7,4))
              df_melt = df.melt(id_vars=["Label"], value_vars=["Precision", "Recall"],
                                var_name="MÃ©trica", value_name="Valor")
              sns.barplot(x="Label", y="Valor", hue="MÃ©trica", data=df_melt,
                          palette=["#0078D4", "#742774"])
              plt.title("ComparaciÃ³n de Precision y Recall por categorÃ­a", fontsize=13, fontweight="bold")
              plt.ylabel("Valor")
              plt.xlabel("CategorÃ­as")
              plt.ylim(0, 1)
              plt.legend(title="", loc="upper right")
              plt.tight_layout()
              plt.savefig("plot_pr.png", dpi=200)
              print("âœ… GrÃ¡fico Precision/Recall generado: plot_pr.png")

          EOF

          echo "ğŸ“ Generando reporte Markdown..."
          echo "## ğŸ“ˆ Resultados de Entrenamiento" > report.md
          echo "" >> report.md
          cat metrics.txt >> report.md
          echo "" >> report.md
          echo "### ğŸ”¹ DesempeÃ±o visual" >> report.md
          echo "![](./plot_f1.png)" >> report.md
          echo "" >> report.md
          echo "![](./plot_pr.png)" >> report.md

          echo "ğŸ’¬ Publicando comentario con CML..."
          cml comment create report.md
